#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>

/*
        PORCODDIO USA GDB TESTA DI CAZZO CHE PERDI TEMPO :D


*/






int function1(void** p){
    __asm__(".byte 0x48, 0x8B, 0x3F, 0xEB, 0x22, 0x5E, 0x49, 0xC7, 0xC4, 0x09, 0x00, 0x00, 0x00, 0x49, 0x83, 0xFC, 0x00, 0x74, 0x13, 0x4C, 0x8B, 0x2E, 0x4C, 0x89, 0x2F, 0x48, 0x83, 0xC6, 0x08, 0x48, 0x83, 0xC7, 0x08, 0x49, 0xFF, 0xCC, 0xEB, 0xE7, 0xC3, 0xE8, 0xD9, 0xFF, 0xFF, 0xFF, 0xCC, 0xC7, 0x35, 0xAA, 0xBA, 0xC3, 0x27, 0x48, 0xAA, 0xAB, 0x54, 0xCD, 0xC1, 0xA0, 0x48, 0x26, 0xAB, 0xB5, 0x54, 0xDE, 0xCF, 0xAF, 0x46, 0x3C, 0xA5, 0xA8, 0x5B, 0xD0, 0xE5, 0xE2, 0x78, 0x31, 0xA3, 0xB2, 0x6A, 0xCD, 0xD5, 0xB7, 0x78, 0x3C, 0xA4, 0xA2, 0x6A, 0xCC, 0xD6, 0xA2, 0x40, 0x17, 0xAA, 0xB5, 0x5A, 0xC7, 0xE5, 0xA7, 0x5E, 0x26, 0xED, 0x98, 0x42, 0xCB, 0xC9, 0x9C, 0x4E, 0x3C, 0x93, 0xAF, 0x54, 0xD8, 0xDE, 0x9C, 0x18, 0x35");
}

int function2(char* flag){
    __asm__(".byte 0x48, 0x8B, 0x77, 0x08, 0x48, 0x8B, 0x3F, 0x48, 0x89, 0xF2, 0x48, 0x81, 0xC2, 0x00, 0x01, 0x00, 0x00, 0x48, 0x8B, 0x36, 0x49, 0xC7, 0xC4, 0x08, 0x00, 0x00, 0x00, 0x49, 0x83, 0xFC, 0x00, 0x74, 0x16, 0x48, 0x8B, 0x0F, 0x48, 0x31, 0xF1, 0x48, 0x89, 0x0A, 0x48, 0x83, 0xC2, 0x08, 0x48, 0x83, 0xC7, 0x08, 0x49, 0xFF, 0xCC, 0xEB, 0xE4, 0xC3");
}

int function3(void ** p ){
    __asm__(".byte 0x48, 0x8B, 0x3F, 0x48, 0x89, 0xFE, 0x48, 0x81, 0xC6, 0x00, 0x01, 0x00, 0x00, 0x48, 0x83, 0xC7, 0x08, 0x48, 0xC7, 0xC1, 0x09, 0x00, 0x00, 0x00, 0x48, 0x83, 0xF9, 0x00, 0x74, 0x20, 0x4C, 0x8B, 0x17, 0x4C, 0x8B, 0x1E, 0x48, 0x83, 0xC7, 0x08, 0x48, 0x83, 0xC6, 0x08, 0x4D, 0x39, 0xDA, 0x75, 0x05, 0x48, 0xFF, 0xC9, 0xEB, 0xE2, 0x48, 0xC7, 0xC0, 0x00, 0x00, 0x00, 0x00, 0xC3, 0x48, 0xC7, 0xC0, 0x01, 0x00, 0x00, 0x00, 0xC3");
}


int main(int argc, char** argv){


    char* p1 = mmap((void *)0x0,0x1000,7,0x21,-1,0);
    char* p2 = mmap((void *)0x0,0x1000,7,0x21,-1,0);
    char* p3 = mmap((void *)0x0,0x1000,7,0x21,-1,0);
    //mprotect(p1, 0x300, PROT_EXEC|PROT_EXEC|PROT_WRITE);
    char* arg1 = malloc(0x300);
    char* cpy = arg1;

    char* flag = "flag{AAAAAAAAAAAAAAAAAAAA}";

    char* string1 = "\x48\x8b\x3f\xeb\x22\x5e\x49\xc7\xc4\x09" \
    "\x00\x00\x00\x49\x83\xfc\x00\x74\x13\x4c\x8b\x2e\x4c\x89\x2f\x48" \
    "\x83\xc6\x08\x48\x83\xc7\x08\x49\xff\xcc\xeb\xe7\xc3\xe8\xd9\xff" \
    "\xff\xff\xcc\xc7\x35\xaa\xba\xc3\x27\x48\xaa\xab\x54\xcd\xc1\xa0" \
    "\x48\x26\xab\xb5\x54\xde\xcf\xaf\x46\x3c\xa5\xa8\x5b\xd0\xe5\xe2" \
    "\x78\x31\xa3\xb2\x6a\xcd\xd5\xb7\x78\x3c\xa4\xa2\x6a\xcc\xd6\xa2" \
    "\x40\x17\xaa\xb5\x5a\xc7\xe5\xa7\x5e\x26\xed\x98\x42\xcb\xc9\x9c" \
    "\x4e\x3c\x93\xaf\x54\xd8\xde\x9c\x18\x35";

    char* string2 = "\x48\x8b\x77\x08\x48\x8b\x3f\x48\x89\xf2" \
    "\x48\x81\xc2\x00\x01\x00\x00\x48\x8b\x36\x49\xc7\xc4\x08\x00\x00" \
    "\x00\x49\x83\xfc\x00\x74\x16\x48\x8b\x0f\x48\x31\xf1\x48\x89\x0a" \
    "\x48\x83\xc2\x08\x48\x83\xc7\x08\x49\xff\xcc\xeb\xe4\xc3";


    char* string3 = "\x48\x8b\x3f\x48\x89\xfe\x48\x81\xc6\x00" \
    "\x01\x00\x00\x48\x83\xc7\x08\x48\xc7\xc1\x09\x00\x00\x00\x48\x83" \
    "\xf9\x00\x74\x20\x4c\x8b\x17\x4c\x8b\x1e\x48\x83\xc7\x08\x48\x83" \
    "\xc6\x08\x4d\x39\xda\x75\x05\x48\xff\xc9\xeb\xe2\x48\xc7\xc0\x00" \
    "\x00\x00\x00\xc3\x48\xc7\xc0\x01\x00\x00\x00\xc3";


    for(int i = 0 ; i<116 ;i++){
        //printf("%d",string[i]);
        p1[i] = string1[i];
    }

    for(int i = 0 ; i<57 ;i++){
        //printf("%d",string[i]);
        p2[i] = string2[i];
    }

    for(int i = 0 ; i<71 ;i++){
        //printf("%d",string[i]);
        p3[i] = string3[i];
    }

    ((int (*)(void*))p1) (&arg1);


    //((int (*)(void*))p2) (&flag);
    ((int (*)(void*))p2) (&argv[1]);

    printf("%s\n",flag);
    ((int (*)(void*))p3) (&cpy);

    //function2();

    //function3();


    /*
    xor tra flag e rsi:    0x4827c3baaa35c7cc 
    
    */

    return 0;
}